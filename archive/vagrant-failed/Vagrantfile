# -*- mode: ruby -*-
# vi: set ft=ruby :
#
# voip-stack Vagrantfile
#
# Creates 3 VMs for VoIP infrastructure using VirtualBox on Apple Silicon:
#   - sip-1:   OpenSIPS SIP Proxy (192.168.56.10)
#   - pbx-1:   Asterisk PBX (192.168.56.30)
#   - media-1: RTPEngine Media Proxy (192.168.56.20)
#
# Prerequisites:
#   brew install --cask virtualbox
#   brew install --cask vagrant
#
# Usage:
#   vagrant up              # Start all VMs
#   vagrant up sip-1        # Start specific VM
#   vagrant ssh sip-1       # SSH into VM
#   vagrant provision       # Run Ansible provisioner
#   vagrant destroy -f      # Destroy all VMs
#   vagrant snapshot push   # Create snapshots
#   vagrant snapshot pop    # Restore snapshots
#

# Minimum Vagrant version required
Vagrant.require_version ">= 2.3.0"

# VM Configuration
# Using generic boxes which support multiple providers including VirtualBox
VM_BOX = "generic/debian12"
VM_BOX_VERSION = ">= 0"

# Network Configuration
# VirtualBox uses 192.168.56.0/24 for host-only networking by default
NETWORK_PREFIX = "192.168.56"

# VM Definitions
VMS = {
  "sip-1" => {
    ip: "#{NETWORK_PREFIX}.10",
    memory: 2048,
    cpus: 2,
    role: "sip_proxy",
    description: "OpenSIPS SIP Proxy",
    ansible_groups: ["sip_proxies", "voip"]
  },
  "media-1" => {
    ip: "#{NETWORK_PREFIX}.20",
    memory: 4096,
    cpus: 4,
    role: "media",
    description: "RTPEngine Media Proxy",
    ansible_groups: ["media_servers", "voip"]
  },
  "pbx-1" => {
    ip: "#{NETWORK_PREFIX}.30",
    memory: 4096,
    cpus: 2,
    role: "pbx",
    description: "Asterisk PBX",
    ansible_groups: ["pbx", "voip"]
  }
}

# DevStack Core host IP (Mac host - accessible via host-only network)
# VirtualBox host-only adapter makes host available at 192.168.56.1
DEVSTACK_HOST = "192.168.56.1"

Vagrant.configure("2") do |config|
  # Common box configuration
  config.vm.box = VM_BOX
  config.vm.box_version = VM_BOX_VERSION

  # Default to VirtualBox provider
  config.vm.provider "virtualbox"

  # SSH configuration
  config.ssh.insert_key = true
  config.ssh.forward_agent = true

  # Disable default synced folder (use Ansible for file transfers)
  config.vm.synced_folder ".", "/vagrant", disabled: true

  # Define each VM
  VMS.each do |vm_name, vm_config|
    config.vm.define vm_name do |vm|
      vm.vm.hostname = vm_name

      # Private network for VM communication (host-only)
      vm.vm.network "private_network",
        ip: vm_config[:ip],
        netmask: "255.255.255.0"

      # VirtualBox provider configuration
      vm.vm.provider "virtualbox" do |vb|
        vb.name = "voip-#{vm_name}"
        vb.memory = vm_config[:memory]
        vb.cpus = vm_config[:cpus]

        # Performance optimizations
        vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
        vb.customize ["modifyvm", :id, "--natdnsproxy1", "on"]
        vb.customize ["modifyvm", :id, "--ioapic", "on"]

        # Disable audio and USB for server VMs
        vb.customize ["modifyvm", :id, "--audio", "none"]
        vb.customize ["modifyvm", :id, "--usb", "off"]

        # Don't display VirtualBox GUI
        vb.gui = false

        # Link clone for faster VM creation
        vb.linked_clone = true
      end

      # VM-specific provisioning message
      vm.vm.provision "shell", inline: <<-SHELL
        echo "=== Provisioning #{vm_name} (#{vm_config[:description]}) ==="
        echo "IP Address: #{vm_config[:ip]}"
        echo "Role: #{vm_config[:role]}"
        echo "DevStack Core: #{DEVSTACK_HOST}"

        # Configure /etc/hosts for DevStack Core access
        grep -q "devstack" /etc/hosts || echo "#{DEVSTACK_HOST} devstack devstack.local" >> /etc/hosts

        # Install essential packages
        apt-get update -qq
        apt-get install -y -qq curl wget vim htop net-tools dnsutils

        # Verify network connectivity to DevStack Core
        echo "Testing connectivity to DevStack Core..."
        curl -s --connect-timeout 5 http://#{DEVSTACK_HOST}:8200/v1/sys/health || echo "Note: Vault not reachable (may need to start DevStack Core)"

        echo "=== Base provisioning complete for #{vm_name} ==="
      SHELL

      # Ansible provisioner (runs after all VMs are up when using --provision)
      # Only configure on the last VM to run once for all
      if vm_name == VMS.keys.last
        vm.vm.provision "ansible" do |ansible|
          ansible.playbook = "../ansible/playbooks/provision-vms.yml"
          ansible.inventory_path = "../ansible/inventory/vagrant.yml"
          ansible.limit = "all"
          ansible.compatibility_mode = "2.0"

          # Ansible configuration
          ansible.extra_vars = {
            ansible_python_interpreter: "/usr/bin/python3",
            devstack_host: DEVSTACK_HOST,
            vault_addr: "http://#{DEVSTACK_HOST}:8200"
          }

          # Group configuration for Ansible inventory
          ansible.groups = {
            "sip_proxies" => ["sip-1"],
            "media_servers" => ["media-1"],
            "pbx" => ["pbx-1"],
            "voip:children" => ["sip_proxies", "media_servers", "pbx"]
          }

          # Enable verbose output with ANSIBLE_VERBOSE=1
          ansible.verbose = ENV['ANSIBLE_VERBOSE'] ? "vv" : false
        end
      end
    end
  end

  # Post-up message
  config.vm.post_up_message = <<-MSG
  ============================================
  voip-stack VMs are ready!
  ============================================

  VMs:
    sip-1:   #{VMS["sip-1"][:ip]} (OpenSIPS)
    media-1: #{VMS["media-1"][:ip]} (RTPEngine)
    pbx-1:   #{VMS["pbx-1"][:ip]} (Asterisk)

  SSH Access:
    vagrant ssh sip-1
    vagrant ssh media-1
    vagrant ssh pbx-1

  Or directly:
    ssh vagrant@#{VMS["sip-1"][:ip]}
    ssh vagrant@#{VMS["media-1"][:ip]}
    ssh vagrant@#{VMS["pbx-1"][:ip]}

  Run Ansible provisioning:
    vagrant provision

  DevStack Core should be running at #{DEVSTACK_HOST}
  ============================================
  MSG
end
